A. Ta sẽ có các collection chính:
- users: Lưu thông tin người dùng
- tasks: Lưu thông tin công việc
- comments: Lưu comment trên task
- teams: Lưu thông tin team (nếu có)
- activityLogs: Lưu nhật ký hoạt động (tuỳ chọn, nhưng tốt cho audit)
- refreshTokens: Lưu refresh token để xoá khi logout (nếu dùng JWT với refresh token)

B. DATABASE COLLECTION DESIGN (tham khảo)
1. USERS Collection:
User {
  _id: ObjectId (MongoDB tự tạo)
  
  // Authentication
  email: String (unique, indexed, required)
  passwordHash: String (hashed với bcrypt) - có thể null nếu dùng Google
  googleId: String (unique, indexed) - cho Google OAuth
  
  // Profile
  name: String (required)
  avatar: String (URL) - có thể lấy từ Google
  
  // Role System
  role: {
    type: String,
    enum: ['admin', 'team_lead', 'user', 'viewer'],
    default: 'user',
    index: true
  }
  
  // Team Assignment
  teamId: ObjectId? (ref: 'Team', index: true)
  teamRole: String? ('lead' hoặc 'member') - denormalized cho performance
  
  // OAuth Info (chỉ lưu cái cần)
  oauthProvider: String? ('google')
  oauthAccessToken: String? (tạm thời)
  oauthRefreshToken: String? (quan trọng, mã hóa)
  oauthTokenExpiry: Date?
  
  // Session Management
  refreshTokens: [{
    token: String,
    deviceInfo: String,
    ipAddress: String,
    createdAt: Date,
    lastUsedAt: Date
  }] - Array capped 5 devices
  
  // Security
  lastPasswordChange: Date
  failedLoginAttempts: { type: Number, default: 0 }
  accountLockedUntil: Date?
  
  // Timestamps
  createdAt: Date (index: true)
  updatedAt: Date
  lastLoginAt: Date
  lastActiveAt: Date
  
  // Status
  isActive: Boolean (default: true)
  isEmailVerified: Boolean (default: false)
  deletedAt: Date? (soft delete)
}
2. TASKS Collection (Core business data)
Task {
  _id: ObjectId
  
  // Basic Info
  title: String (required, index: text)
  description: String
  
  // Status & Priority
  status: {
    type: String,
    enum: ['todo', 'in_progress', 'done'],
    default: 'todo',
    index: true
  }
  priority: {
    type: String,
    enum: ['low', 'medium', 'high'],
    default: 'medium',
    index: true
  }
  
  // Ownership
  createdBy: ObjectId (ref: 'User', required, index: true)
  assignedTo: ObjectId? (ref: 'User', index: true)
  teamId: ObjectId? (ref: 'Team', index: true)
  
  // Organization
  category: String? (index: true)
  tags: [String] (index: true) - mảng các tag
  
  // Time Management
  dueDate: Date? (index: true)
  completedAt: Date?
  
  // Permissions
  visibility: {
    type: String,
    enum: ['private', 'team', 'public'],
    default: 'private'
  }
  sharedWith: [ObjectId] (ref: 'User') - user IDs được share
  
  // Metadata
  createdAt: Date (index: true)
  updatedAt: Date
  updatedBy: ObjectId? (ref: 'User')
  
  // Soft delete
  isArchived: Boolean (default: false)
}
3. COMMENTS Collection
Comment {
  _id: ObjectId
  
  // Reference
  taskId: ObjectId (ref: 'Task', required, index: true)
  userId: ObjectId (ref: 'User', required, index: true)
  
  // Content
  content: String (required)
  mentions: [ObjectId] (ref: 'User') - user IDs được mention
  
  // Metadata
  createdAt: Date (index: true)
  updatedAt: Date
  
  // Hierarchy (cho nested comments)
  parentCommentId: ObjectId? (ref: 'Comment')
  
  // Soft delete (giữ comment nhưng mark là deleted)
  isDeleted: Boolean (default: false)
  deletedAt: Date?
}
4. TEAMS Collection
Team {
  _id: ObjectId
  
  // Basic Info
  name: String (required, unique)
  description: String?
  
  // Leadership
  leadId: ObjectId (ref: 'User', index: true)
  
  // Members (denormalized cho performance)
  members: [{
    userId: ObjectId (ref: 'User'),
    role: String ('member' hoặc 'viewer'),
    joinedAt: Date
  }]
  
  // Settings
  settings: {
    maxMembers: Number (default: 50),
    allowExternalSharing: Boolean (default: false)
  }
  
  // Metadata
  createdAt: Date
  updatedAt: Date
  createdBy: ObjectId (ref: 'User') - admin tạo team
  
  // Status
  isActive: Boolean (default: true)
}
5. ACTIVITY LOGS Collection
ActivityLog {
  _id: ObjectId
  
  // Actor
  userId: ObjectId (ref: 'User', index: true)
  userRole: String (denormalized từ user.role)
  
  // Action
  action: String (index: true) // 'create_task', 'update_task', 'delete_comment', etc.
  resourceType: String // 'Task', 'Comment', 'User'
  resourceId: ObjectId // ID của resource
  
  // Changes (diff)
  changes: {
    before: Object?,
    after: Object?,
    fieldsChanged: [String]
  }
  
  // Context
  ipAddress: String?
  userAgent: String?
  
  // Timestamp
  timestamp: Date (index: true - descending)
  
  // Auto-expire (TTL index - 90 days)
  expiresAt: Date
}
6. REFRESH TOKENS Collection (Quản lý session)

RefreshToken {
  _id: ObjectId
  
  // Token Info
  token: String (required, unique, index: true)
  userId: ObjectId (ref: 'User', required, index: true)
  
  // Device Info
  deviceId: String? (client-generated)
  deviceInfo: String? (browser/OS)
  ipAddress: String?
  
  // Validity
  issuedAt: Date
  expiresAt: Date (required, index: true)
  
  // Usage
  lastUsedAt: Date
  
  // Status
  isRevoked: Boolean (default: false)
  revokedAt: Date?
  
  // Auto cleanup với TTL index (30 days sau expiresAt)
}

C. INDEXING STRATEGY (Chỉ những index THỰC SỰ cần)

1.USERS Collection Indexes:
// 1. Email lookup (login)
db.users.createIndex({ email: 1 }, { unique: true })

// 2. Google OAuth lookup
db.users.createIndex({ googleId: 1 }, { 
  unique: true, 
  sparse: true 
})

// 3. Role-based queries
db.users.createIndex({ role: 1 })

// 4. Team-based queries
db.users.createIndex({ teamId: 1 })

// 5. Active users queries
db.users.createIndex({ isActive: 1, role: 1 })

2.TASKS Collection Indexes:
// 1. User's tasks (most common query)
db.tasks.createIndex({ 
  createdBy: 1, 
  status: 1, 
  createdAt: -1 
})

// 2. Assigned tasks
db.tasks.createIndex({ 
  assignedTo: 1, 
  status: 1 
})

// 3. Team tasks
db.tasks.createIndex({ 
  teamId: 1, 
  status: 1 
})

// 4. Due date queries
db.tasks.createIndex({ 
  dueDate: 1, 
  status: 1 
})

// 5. Search by title/description
db.tasks.createIndex({ 
  title: 'text', 
  description: 'text' 
})

// 6. Filter by tags
db.tasks.createIndex({ tags: 1 })

// 7. Category queries
db.tasks.createIndex({ category: 1 })

3. COMMENTS Collection Indexes:
// 1. Get comments for a task
db.comments.createIndex({ 
  taskId: 1, 
  createdAt: -1 
})

// 2. User's comments
db.comments.createIndex({ 
  userId: 1, 
  createdAt: -1 
})

4. TTL Indexes (Auto-cleanup):
// 1. Refresh tokens expire sau 30 ngày
db.refreshTokens.createIndex(
  { expiresAt: 1 },
  { expireAfterSeconds: 2592000 } // 30 days
)

// 2. Activity logs expire sau 90 ngày
db.activityLogs.createIndex(
  { expiresAt: 1 },
  { expireAfterSeconds: 7776000 } // 90 days
)

// 3. Failed login attempts reset
db.users.createIndex(
  { accountLockedUntil: 1 },
  { expireAfterSeconds: 3600, sparse: true } // 1 hour
)